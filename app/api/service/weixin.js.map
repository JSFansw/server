{
    "version": 3,
    "sources": [
        "../../../src/api/service/weixin.js"
    ],
    "names": [
        "crypto",
        "require",
        "md5",
        "module",
        "exports",
        "think",
        "Service",
        "decryptUserInfoData",
        "sessionKey",
        "encryptedData",
        "iv",
        "_sessionKey",
        "Buffer",
        "from",
        "decoded",
        "decipher",
        "createDecipheriv",
        "setAutoPadding",
        "update",
        "final",
        "JSON",
        "parse",
        "err",
        "watermark",
        "appid",
        "config",
        "createUnifiedOrder",
        "payInfo",
        "WeiXinPay",
        "weixinpay",
        "openid",
        "mch_id",
        "partner_key",
        "Promise",
        "resolve",
        "reject",
        "body",
        "out_trade_no",
        "total_fee",
        "spbill_create_ip",
        "notify_url",
        "trade_type",
        "res",
        "return_code",
        "result_code",
        "returnParams",
        "parseInt",
        "Date",
        "now",
        "nonce_str",
        "prepay_id",
        "paramStr",
        "nonceStr",
        "package",
        "signType",
        "timeStamp",
        "paySign",
        "toUpperCase",
        "buildQuery",
        "queryObj",
        "sortPayOptions",
        "key",
        "Object",
        "keys",
        "sort",
        "payOptionQuery",
        "substring",
        "length",
        "signQuery",
        "queryStr",
        "md5Sign",
        "payNotify",
        "notifyData",
        "isEmpty",
        "notifyObj",
        "sign",
        "signString"
    ],
    "mappings": "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",
    "file": "../../../src/api/service/weixin.js",
    "sourcesContent": [
        "const crypto = require('crypto');\r\nconst md5 = require('md5');\r\n\r\nmodule.exports = class extends think.Service {\r\n  /**\r\n   * 解析微信登录用户数据\r\n   * @param sessionKey\r\n   * @param encryptedData\r\n   * @param iv\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async decryptUserInfoData(sessionKey, encryptedData, iv) {\r\n    // base64 decode\r\n    const _sessionKey = Buffer.from(sessionKey, 'base64');\r\n    encryptedData = Buffer.from(encryptedData, 'base64');\r\n    iv = Buffer.from(iv, 'base64');\r\n    let decoded = '';\r\n    try {\r\n      // 解密\r\n      const decipher = crypto.createDecipheriv('aes-128-cbc', _sessionKey, iv);\r\n      // 设置自动 padding 为 true，删除填充补位\r\n      decipher.setAutoPadding(true);\r\n      decoded = decipher.update(encryptedData, 'binary', 'utf8');\r\n      decoded += decipher.final('utf8');\r\n\r\n      decoded = JSON.parse(decoded);\r\n    } catch (err) {\r\n      return '';\r\n    }\r\n\r\n    if (decoded.watermark.appid !== think.config('weixin.appid')) {\r\n      return '';\r\n    }\r\n\r\n    return decoded;\r\n  }\r\n\r\n  /**\r\n   * 统一下单\r\n   * @param payInfo\r\n   * @returns {Promise}\r\n   */\r\n  createUnifiedOrder(payInfo) {\r\n    const WeiXinPay = require('weixinpay');\r\n    const weixinpay = new WeiXinPay({\r\n      appid: think.config('weixin.appid'), // 微信小程序appid\r\n      openid: payInfo.openid, // 用户openid\r\n      mch_id: think.config('weixin.mch_id'), // 商户帐号ID\r\n      partner_key: think.config('weixin.partner_key') // 秘钥\r\n    });\r\n    return new Promise((resolve, reject) => {\r\n      weixinpay.createUnifiedOrder({\r\n        body: payInfo.body,\r\n        out_trade_no: payInfo.out_trade_no,\r\n        total_fee: payInfo.total_fee,\r\n        spbill_create_ip: payInfo.spbill_create_ip,\r\n        notify_url: think.config('weixin.notify_url'),\r\n        trade_type: 'JSAPI'\r\n      }, (res) => {\r\n        if (res.return_code === 'SUCCESS' && res.result_code === 'SUCCESS') {\r\n          const returnParams = {\r\n            'appid': res.appid,\r\n            'timeStamp': parseInt(Date.now() / 1000) + '',\r\n            'nonceStr': res.nonce_str,\r\n            'package': 'prepay_id=' + res.prepay_id,\r\n            'signType': 'MD5'\r\n          };\r\n          const paramStr = `appId=${returnParams.appid}&nonceStr=${returnParams.nonceStr}&package=${returnParams.package}&signType=${returnParams.signType}&timeStamp=${returnParams.timeStamp}&key=` + think.config('weixin.partner_key');\r\n          returnParams.paySign = md5(paramStr).toUpperCase();\r\n          resolve(returnParams);\r\n        } else {\r\n          reject(res);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 生成排序后的支付参数 query\r\n   * @param queryObj\r\n   * @returns {Promise.<string>}\r\n   */\r\n  buildQuery(queryObj) {\r\n    const sortPayOptions = {};\r\n    for (const key of Object.keys(queryObj).sort()) {\r\n      sortPayOptions[key] = queryObj[key];\r\n    }\r\n    let payOptionQuery = '';\r\n    for (const key of Object.keys(sortPayOptions).sort()) {\r\n      payOptionQuery += key + '=' + sortPayOptions[key] + '&';\r\n    }\r\n    payOptionQuery = payOptionQuery.substring(0, payOptionQuery.length - 1);\r\n    return payOptionQuery;\r\n  }\r\n\r\n  /**\r\n   * 对 query 进行签名\r\n   * @param queryStr\r\n   * @returns {Promise.<string>}\r\n   */\r\n  signQuery(queryStr) {\r\n    queryStr = queryStr + '&key=' + think.config('weixin.partner_key');\r\n    const md5 = require('md5');\r\n    const md5Sign = md5(queryStr);\r\n    return md5Sign.toUpperCase();\r\n  }\r\n\r\n  /**\r\n   * 处理微信支付回调\r\n   * @param notifyData\r\n   * @returns {{}}\r\n   */\r\n  payNotify(notifyData) {\r\n    if (think.isEmpty(notifyData)) {\r\n      return false;\r\n    }\r\n\r\n    const notifyObj = {};\r\n    let sign = '';\r\n    for (const key of Object.keys(notifyData)) {\r\n      if (key !== 'sign') {\r\n        notifyObj[key] = notifyData[key][0];\r\n      } else {\r\n        sign = notifyData[key][0];\r\n      }\r\n    }\r\n    if (notifyObj.return_code !== 'SUCCESS' || notifyObj.result_code !== 'SUCCESS') {\r\n      return false;\r\n    }\r\n    const signString = this.signQuery(this.buildQuery(notifyObj));\r\n    if (think.isEmpty(sign) || signString !== sign) {\r\n      return false;\r\n    }\r\n    return notifyObj;\r\n  }\r\n};\r\n"
    ]
}