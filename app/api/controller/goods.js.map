{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\goods.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "indexAction",
        "model",
        "goodsList",
        "select",
        "success",
        "skuAction",
        "goodsId",
        "get",
        "specificationList",
        "getSpecificationList",
        "productList",
        "getProductList",
        "detailAction",
        "info",
        "where",
        "find",
        "gallery",
        "goods_id",
        "limit",
        "attribute",
        "field",
        "join",
        "order",
        "issue",
        "brand",
        "id",
        "brand_id",
        "commentCount",
        "value_id",
        "type_id",
        "count",
        "hotComment",
        "commentInfo",
        "think",
        "isEmpty",
        "commentUser",
        "user_id",
        "content",
        "Buffer",
        "from",
        "toString",
        "add_time",
        "datetime",
        "Date",
        "nickname",
        "avatar",
        "pic_list",
        "comment_id",
        "comment",
        "data",
        "userHasCollect",
        "isUserHasCollect",
        "userId",
        "addFootprint",
        "categoryAction",
        "currentCategory",
        "parentCategory",
        "parent_id",
        "brotherCategory",
        "listAction",
        "categoryId",
        "brandId",
        "keyword",
        "isNew",
        "isHot",
        "page",
        "size",
        "sort",
        "goodsQuery",
        "whereMap",
        "is_new",
        "is_hot",
        "name",
        "add",
        "parseInt",
        "getTime",
        "orderMap",
        "retail_price",
        "filterCategory",
        "categoryIds",
        "getField",
        "parentIds",
        "concat",
        "category_id",
        "getCategoryWhereIn",
        "goodsData",
        "countSelect",
        "map",
        "v",
        "checked",
        "filterAction",
        "getChildCategoryId",
        "newAction",
        "bannerInfo",
        "url",
        "img_url",
        "hotAction",
        "relatedAction",
        "relatedGoodsIds",
        "relatedGoods",
        "goodsCategory",
        "countAction",
        "goodsCount",
        "is_delete",
        "is_on_sale"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\goods.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\n\r\nmodule.exports = class extends Base {\r\n  async indexAction() {\r\n    const model = this.model('goods');\r\n    const goodsList = await model.select();\r\n\r\n    return this.success(goodsList);\r\n  }\r\n\r\n  /**\r\n   * 获取sku信息，用于购物车编辑时选择规格\r\n   * @returns {Promise.<Promise|PreventPromise|void>}\r\n   */\r\n  async skuAction() {\r\n    const goodsId = this.get('id');\r\n    const model = this.model('goods');\r\n\r\n    return this.success({\r\n      specificationList: await model.getSpecificationList(goodsId),\r\n      productList: await model.getProductList(goodsId)\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 商品详情页数据\r\n   * @returns {Promise.<Promise|PreventPromise|void>}\r\n   */\r\n  async detailAction() {\r\n    const goodsId = this.get('id');\r\n    const model = this.model('goods');\r\n\r\n    const info = await model.where({'id': goodsId}).find();\r\n    const gallery = await this.model('goods_gallery').where({goods_id: goodsId}).limit(4).select();\r\n    const attribute = await this.model('goods_attribute').field('nideshop_goods_attribute.value, nideshop_attribute.name').join('nideshop_attribute ON nideshop_goods_attribute.attribute_id=nideshop_attribute.id').order({'nideshop_goods_attribute.id': 'asc'}).where({'nideshop_goods_attribute.goods_id': goodsId}).select();\r\n    const issue = await this.model('goods_issue').select();\r\n    const brand = await this.model('brand').where({id: info.brand_id}).find();\r\n    const commentCount = await this.model('comment').where({value_id: goodsId, type_id: 0}).count();\r\n    const hotComment = await this.model('comment').where({value_id: goodsId, type_id: 0}).find();\r\n    let commentInfo = {};\r\n    if (!think.isEmpty(hotComment)) {\r\n      const commentUser = await this.model('user').field(['nickname', 'username', 'avatar']).where({id: hotComment.user_id}).find();\r\n      commentInfo = {\r\n        content: Buffer.from(hotComment.content, 'base64').toString(),\r\n        add_time: think.datetime(new Date(hotComment.add_time * 1000)),\r\n        nickname: commentUser.nickname,\r\n        avatar: commentUser.avatar,\r\n        pic_list: await this.model('comment_picture').where({comment_id: hotComment.id}).select()\r\n      };\r\n    }\r\n\r\n    const comment = {\r\n      count: commentCount,\r\n      data: commentInfo\r\n    };\r\n\r\n    // 当前用户是否收藏\r\n    const userHasCollect = await this.model('collect').isUserHasCollect(think.userId, 0, goodsId);\r\n\r\n    // 记录用户的足迹 TODO\r\n    await await this.model('footprint').addFootprint(think.userId, goodsId);\r\n\r\n    // return this.json(jsonData);\r\n    return this.success({\r\n      info: info,\r\n      gallery: gallery,\r\n      attribute: attribute,\r\n      userHasCollect: userHasCollect,\r\n      issue: issue,\r\n      comment: comment,\r\n      brand: brand,\r\n      specificationList: await model.getSpecificationList(goodsId),\r\n      productList: await model.getProductList(goodsId)\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获取分类下的商品\r\n   * @returns {Promise.<*>}\r\n   */\r\n  async categoryAction() {\r\n    const model = this.model('category');\r\n    const currentCategory = await model.where({id: this.get('id')}).find();\r\n    const parentCategory = await model.where({id: currentCategory.parent_id}).find();\r\n    const brotherCategory = await model.where({parent_id: currentCategory.parent_id}).select();\r\n\r\n    return this.success({\r\n      currentCategory: currentCategory,\r\n      parentCategory: parentCategory,\r\n      brotherCategory: brotherCategory\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获取商品列表\r\n   * @returns {Promise.<*>}\r\n   */\r\n  async listAction() {\r\n    const categoryId = this.get('categoryId');\r\n    const brandId = this.get('brandId');\r\n    const keyword = this.get('keyword');\r\n    const isNew = this.get('isNew');\r\n    const isHot = this.get('isHot');\r\n    const page = this.get('page');\r\n    const size = this.get('size');\r\n    const sort = this.get('sort');\r\n    const order = this.get('order');\r\n\r\n    const goodsQuery = this.model('goods');\r\n\r\n    const whereMap = {};\r\n    if (!think.isEmpty(isNew)) {\r\n      whereMap.is_new = isNew;\r\n    }\r\n\r\n    if (!think.isEmpty(isHot)) {\r\n      whereMap.is_hot = isHot;\r\n    }\r\n\r\n    if (!think.isEmpty(keyword)) {\r\n      whereMap.name = ['like', `%${keyword}%`];\r\n      // 添加到搜索历史\r\n      await this.model('search_history').add({\r\n        keyword: keyword,\r\n        user_id: think.userId,\r\n        add_time: parseInt(new Date().getTime() / 1000)\r\n      });\r\n    }\r\n\r\n    if (!think.isEmpty(brandId)) {\r\n      whereMap.brand_id = brandId;\r\n    }\r\n\r\n    // 排序\r\n    let orderMap = {};\r\n    if (sort === 'price') {\r\n      // 按价格\r\n      orderMap = {\r\n        retail_price: order\r\n      };\r\n    } else {\r\n      // 按商品添加时间\r\n      orderMap = {\r\n        id: 'desc'\r\n      };\r\n    }\r\n\r\n    // 筛选的分类\r\n    let filterCategory = [{\r\n      'id': 0,\r\n      'name': '全部',\r\n      'checked': false\r\n    }];\r\n\r\n    const categoryIds = await goodsQuery.where(whereMap).getField('category_id', 10000);\r\n    if (!think.isEmpty(categoryIds)) {\r\n      // 查找二级分类的parent_id\r\n      const parentIds = await this.model('category').where({id: {'in': categoryIds}}).getField('parent_id', 10000);\r\n      // 一级分类\r\n      const parentCategory = await this.model('category').field(['id', 'name']).order({'sort_order': 'asc'}).where({'id': {'in': parentIds}}).select();\r\n\r\n      if (!think.isEmpty(parentCategory)) {\r\n        filterCategory = filterCategory.concat(parentCategory);\r\n      }\r\n    }\r\n\r\n    // 加入分类条件\r\n    if (!think.isEmpty(categoryId) && parseInt(categoryId) > 0) {\r\n      whereMap.category_id = ['in', await this.model('category').getCategoryWhereIn(categoryId)];\r\n    }\r\n\r\n    // 搜索到的商品\r\n    const goodsData = await goodsQuery.where(whereMap).field(['id', 'name', 'list_pic_url', 'retail_price']).order(orderMap).page(page, size).countSelect();\r\n    goodsData.filterCategory = filterCategory.map(function(v) {\r\n      v.checked = (think.isEmpty(categoryId) && v.id === 0) || v.id === parseInt(categoryId);\r\n      return v;\r\n    });\r\n    goodsData.goodsList = goodsData.data;\r\n\r\n    return this.success(goodsData);\r\n  }\r\n\r\n  /**\r\n   * 商品列表筛选的分类列表\r\n   * @returns {Promise.<Promise|void|PreventPromise>}\r\n   */\r\n  async filterAction() {\r\n    const categoryId = this.get('categoryId');\r\n    const keyword = this.get('keyword');\r\n    const isNew = this.get('isNew');\r\n    const isHot = this.get('isHot');\r\n\r\n    const goodsQuery = this.model('goods');\r\n\r\n    if (!think.isEmpty(categoryId)) {\r\n      goodsQuery.where({category_id: {'in': await this.model('category').getChildCategoryId(categoryId)}});\r\n    }\r\n\r\n    if (!think.isEmpty(isNew)) {\r\n      goodsQuery.where({is_new: isNew});\r\n    }\r\n\r\n    if (!think.isEmpty(isHot)) {\r\n      goodsQuery.where({is_hot: isHot});\r\n    }\r\n\r\n    if (!think.isEmpty(keyword)) {\r\n      goodsQuery.where({name: {'like': `%${keyword}%`}});\r\n    }\r\n\r\n    let filterCategory = [{\r\n      'id': 0,\r\n      'name': '全部'\r\n    }];\r\n\r\n    // 二级分类id\r\n    const categoryIds = await goodsQuery.getField('category_id', 10000);\r\n    if (!think.isEmpty(categoryIds)) {\r\n      // 查找二级分类的parent_id\r\n      const parentIds = await this.model('category').where({id: {'in': categoryIds}}).getField('parent_id', 10000);\r\n      // 一级分类\r\n      const parentCategory = await this.model('category').field(['id', 'name']).order({'sort_order': 'asc'}).where({'id': {'in': parentIds}}).select();\r\n\r\n      if (!think.isEmpty(parentCategory)) {\r\n        filterCategory = filterCategory.concat(parentCategory);\r\n      }\r\n    }\r\n\r\n    return this.success(filterCategory);\r\n  }\r\n\r\n  /**\r\n   * 新品首发\r\n   * @returns {Promise.<Promise|void|PreventPromise>}\r\n   */\r\n  async newAction() {\r\n    return this.success({\r\n      bannerInfo: {\r\n        url: '',\r\n        name: '坚持初心，为你寻觅世间好物',\r\n        img_url: 'http://yanxuan.nosdn.127.net/8976116db321744084774643a933c5ce.png'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 人气推荐\r\n   * @returns {Promise.<Promise|void|PreventPromise>}\r\n   */\r\n  async hotAction() {\r\n    return this.success({\r\n      bannerInfo: {\r\n        url: '',\r\n        name: '大家都在买的严选好物',\r\n        img_url: 'http://yanxuan.nosdn.127.net/8976116db321744084774643a933c5ce.png'\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 商品详情页的大家都在看的商品\r\n   * @returns {Promise.<Promise|PreventPromise|void>}\r\n   */\r\n  async relatedAction() {\r\n    // 大家都在看商品,取出关联表的商品，如果没有则随机取同分类下的商品\r\n    const model = this.model('goods');\r\n    const goodsId = this.get('id');\r\n    const relatedGoodsIds = await this.model('related_goods').where({goods_id: goodsId}).getField('related_goods_id');\r\n    let relatedGoods = null;\r\n    if (think.isEmpty(relatedGoodsIds)) {\r\n      // 查找同分类下的商品\r\n      const goodsCategory = await model.where({id: goodsId}).find();\r\n      relatedGoods = await model.where({category_id: goodsCategory.category_id}).field(['id', 'name', 'list_pic_url', 'retail_price']).limit(8).select();\r\n    } else {\r\n      relatedGoods = await model.where({id: ['IN', relatedGoodsIds]}).field(['id', 'name', 'list_pic_url', 'retail_price']).select();\r\n    }\r\n\r\n    return this.success({\r\n      goodsList: relatedGoods\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 在售的商品总数\r\n   * @returns {Promise.<Promise|PreventPromise|void>}\r\n   */\r\n  async countAction() {\r\n    const goodsCount = await this.model('goods').where({is_delete: 0, is_on_sale: 1}).count('id');\r\n\r\n    return this.success({\r\n      goodsCount: goodsCount\r\n    });\r\n  }\r\n};\r\n"
    ]
}