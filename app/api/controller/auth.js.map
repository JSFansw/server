{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\auth.js"
    ],
    "names": [
        "Base",
        "require",
        "rp",
        "module",
        "exports",
        "loginByWeixinAction",
        "code",
        "post",
        "fullUserInfo",
        "userInfo",
        "clientIp",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "js_code",
        "secret",
        "think",
        "config",
        "appid",
        "sessionData",
        "JSON",
        "parse",
        "openid",
        "fail",
        "crypto",
        "sha1",
        "createHash",
        "update",
        "rawData",
        "session_key",
        "digest",
        "signature",
        "WeixinSerivce",
        "service",
        "weixinUserInfo",
        "decryptUserInfoData",
        "encryptedData",
        "iv",
        "isEmpty",
        "userId",
        "model",
        "where",
        "weixin_openid",
        "getField",
        "add",
        "username",
        "uuid",
        "password",
        "register_time",
        "parseInt",
        "Date",
        "getTime",
        "register_ip",
        "last_login_time",
        "last_login_ip",
        "mobile",
        "avatar",
        "avatarUrl",
        "gender",
        "nickname",
        "nickName",
        "user_id",
        "newUserInfo",
        "field",
        "id",
        "find",
        "TokenSerivce",
        "sessionKey",
        "create",
        "success",
        "token",
        "logoutAction"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\auth.js",
    "sourcesContent": [
        "const Base = require('./base.js');\r\nconst rp = require('request-promise');\r\n\r\nmodule.exports = class extends Base {\r\n  async loginByWeixinAction() {\r\n    const code = this.post('code');\r\n    const fullUserInfo = this.post('userInfo');\r\n    const userInfo = fullUserInfo.userInfo;\r\n    const clientIp = ''; // 暂时不记录 ip\r\n\r\n    // 获取openid\r\n    const options = {\r\n      method: 'GET',\r\n      url: 'https://api.weixin.qq.com/sns/jscode2session',\r\n      qs: {\r\n        grant_type: 'authorization_code',\r\n        js_code: code,\r\n        secret: think.config('weixin.secret'),\r\n        appid: think.config('weixin.appid')\r\n      }\r\n    };\r\n\r\n    let sessionData = await rp(options);\r\n    sessionData = JSON.parse(sessionData);\r\n    if (!sessionData.openid) {\r\n      return this.fail('登录失败');\r\n    }\r\n\r\n    // 验证用户信息完整性\r\n    const crypto = require('crypto');\r\n    const sha1 = crypto.createHash('sha1').update(fullUserInfo.rawData + sessionData.session_key).digest('hex');\r\n    if (fullUserInfo.signature !== sha1) {\r\n      return this.fail('登录失败');\r\n    }\r\n\r\n    // 解释用户数据\r\n    const WeixinSerivce = this.service('weixin', 'api');\r\n    const weixinUserInfo = await WeixinSerivce.decryptUserInfoData(sessionData.session_key, fullUserInfo.encryptedData, fullUserInfo.iv);\r\n    if (think.isEmpty(weixinUserInfo)) {\r\n      return this.fail('登录失败');\r\n    }\r\n\r\n    // 根据openid查找用户是否已经注册\r\n    let userId = await this.model('user').where({ weixin_openid: sessionData.openid }).getField('id', true);\r\n    if (think.isEmpty(userId)) {\r\n      // 注册\r\n      userId = await this.model('user').add({\r\n        username: '微信用户' + think.uuid(6),\r\n        password: sessionData.openid,\r\n        register_time: parseInt(new Date().getTime() / 1000),\r\n        register_ip: clientIp,\r\n        last_login_time: parseInt(new Date().getTime() / 1000),\r\n        last_login_ip: clientIp,\r\n        mobile: '',\r\n        weixin_openid: sessionData.openid,\r\n        avatar: userInfo.avatarUrl || '',\r\n        gender: userInfo.gender || 1, // 性别 0：未知、1：男、2：女\r\n        nickname: userInfo.nickName\r\n      });\r\n    }\r\n\r\n    sessionData.user_id = userId;\r\n\r\n    // 查询用户信息\r\n    const newUserInfo = await this.model('user').field(['id', 'username', 'nickname', 'gender', 'avatar', 'birthday']).where({ id: userId }).find();\r\n\r\n    // 更新登录信息\r\n    userId = await this.model('user').where({ id: userId }).update({\r\n      last_login_time: parseInt(new Date().getTime() / 1000),\r\n      last_login_ip: clientIp\r\n    });\r\n\r\n    const TokenSerivce = this.service('token', 'api');\r\n    const sessionKey = await TokenSerivce.create(sessionData);\r\n\r\n    if (think.isEmpty(newUserInfo) || think.isEmpty(sessionKey)) {\r\n      return this.fail('登录失败');\r\n    }\r\n\r\n    return this.success({ token: sessionKey, userInfo: newUserInfo });\r\n  }\r\n\r\n  async logoutAction() {\r\n    return this.success();\r\n  }\r\n};\r\n"
    ]
}